<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ASCII Art Converter</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #result {
            white-space: pre;
            background: #f0f0f0;
            padding: 20px;
            font-size: 12px;
            overflow-x: auto;
        }

        canvas {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ASCII Art Converter</h1>

        <div class="input-group">
            <label>画像をアップロード:</label>
            <input type="file" id="imageInput" accept="image/*">
            <button onclick="convertImage()">画像を変換</button>
        </div>

        <div class="input-group">
            <label>テキストを入力:</label>
            <input type="text" id="textInput">
            <button onclick="convertText()">テキストを変換</button>
        </div>

        <div class="input-group">
            <label>設定:</label>
            <input type="number" id="width" value="50" min="10" max="200">
            <select id="charset">
                <option value="binary">ちょーシンプル（2段階）</option>
                <option value="simple">シンプル（10段階）</option>
                <option value="detailed">詳細（77段階）</option>
            </select>
        </div>

        <pre id="result"></pre>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const result = document.getElementById('result');

        // ASCII文字セット
        const charsets = {
            binary: '@ ',
            simple: '@%#*+=-:. ',
            detailed: '@W#$BG8EMR&O0QDS5Z2UYKJ7PX3VF64LAH9NIwmebdpqkxgoa?/\\|()1{}[]<>i!lI;:,"^`\'. '
        };

        // 画像処理
        function convertImage() {
            const file = document.getElementById("imageInput").files[0];
            if (!file) return;

            const img = new Image();
            img.src = URL.createObjectURL(file);

            img.onload = () => {
                const width = parseInt(document.getElementById('width').value);
                const height = Math.floor(width * (img.height / img.width));

                canvas.width = width;
                canvas.height = height;

                // 画像の描画
                ctx.drawImage(img, 0, 0, width, height);

                // グレースケール変換とASCII変換
                const imageData = ctx.getImageData(0, 0, width, height);
                const ascii = convertToAscii(imageData, width);

                result.textContent = ascii;
            };
        };

        // テキスト処理
        function convertText() {
            const text = document.getElementById('textInput').value;
            if (!text) return;

            const width = parseInt(document.getElementById('width').value);
            const fontSize = width / 2

            ctx.font = `${fontSize}px sans-serif`;
            const metrics = ctx.measureText(text);
            const height = fontSize * Math.ceil(metrics.width / width); // 高さを計算

            canvas.width = width;
            canvas.height = height;

            // 背景を白に
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);

            // テキストの設定
            ctx.fillStyle = 'black';
            ctx.font = `${fontSize}px sans-serif`;

            // テキストを改行しながら描画
            let line = '';
            let y = fontSize;
            const lineHeight = fontSize * 0.9; // 行間を狭くするために調整
            for (let i = 0; i < text.length; i++) {
                line += text[i];
                if (ctx.measureText(line).width > width) {
                    ctx.fillText(line.slice(0, -1), 0, y);
                    line = text[i];
                    y += lineHeight;
                }
            }
            ctx.fillText(line, 0, y);

            // ASCII変換
            const imageData = ctx.getImageData(0, 0, width, height);
            const ascii = convertToAscii(imageData, width);

            result.textContent = ascii;
        }

        // ASCII変換関数
        function convertToAscii(imageData, width) {
            const charset = charsets[document.getElementById('charset').value];
            let ascii = '';

            for (let i = 0; i < imageData.data.length; i += 4) {
                if (i % (width * 4) === 0 && i !== 0) {
                    ascii += '\n';
                }

                // グレースケール値の計算
                const r = imageData.data[i];
                const g = imageData.data[i + 1];
                const b = imageData.data[i + 2];
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;

                // グレースケール値を文字に変換
                const charIndex = Math.floor((gray * (charset.length - 1)) / 255);
                ascii += charset[charIndex];
            }

            return ascii;
        }

    </script>
</body>

</html>
